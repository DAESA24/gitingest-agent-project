# Story 1.6: Extractor Module - Full Extraction

## Status
Draft

## Story
**As a** developer implementing extraction workflows,
**I want** an extractor module that wraps GitIngest CLI for full repository extraction,
**so that** I can reliably extract entire repositories and save them to the data/ directory with proper error handling.

## Acceptance Criteria
1. extractor.py module created with full extraction functionality
2. extract_full() extracts entire repository to data/[repo-name]/digest.txt
3. _run_gitingest() private helper function handles subprocess execution
4. Automatic directory creation (mkdir -p behavior)
5. Timeout protection (300 seconds / 5 minutes)
6. Comprehensive error handling for network, timeout, and filesystem errors
7. Unit tests verify extraction logic with mocked subprocess

## Tasks / Subtasks

- [ ] **Task 1: Create extractor.py module with imports** (AC: 1)
  - [ ] Create extractor.py at project root
  - [ ] Import subprocess for GitIngest execution
  - [ ] Import pathlib.Path for file operations
  - [ ] Import exceptions (GitIngestError, StorageError)
  - [ ] Import storage module functions

- [ ] **Task 2: Implement _run_gitingest() helper function** (AC: 3, 5, 6)
  - [ ] Accept args parameter (list of GitIngest arguments)
  - [ ] Accept timeout parameter (default 300 seconds)
  - [ ] Build command: ['gitingest'] + args
  - [ ] Execute subprocess with capture_output=True, text=True, check=True
  - [ ] Handle subprocess.TimeoutExpired → raise TimeoutError
  - [ ] Handle subprocess.CalledProcessError → parse stderr, raise GitIngestError
  - [ ] Parse error messages: "not found", "bad credentials", etc.
  - [ ] Return subprocess.CompletedProcess

- [ ] **Task 3: Implement extract_full() function** (AC: 2, 4)
  - [ ] Accept url parameter (GitHub URL)
  - [ ] Accept repo_name parameter (repository name for storage)
  - [ ] Call storage.ensure_data_directory(repo_name) to create directory
  - [ ] Define output_file path: data_dir / "digest.txt"
  - [ ] Build GitIngest arguments: [url, '-o', str(output_file)]
  - [ ] Call _run_gitingest() with arguments
  - [ ] Return absolute path to output file
  - [ ] Wrap filesystem errors in StorageError

- [ ] **Task 4: Write unit tests for extractor.py** (AC: 7)
  - [ ] Test extract_full() with mocked subprocess (successful extraction)
  - [ ] Test extract_full() directory creation
  - [ ] Test extract_full() returns absolute path
  - [ ] Test _run_gitingest() timeout handling
  - [ ] Test _run_gitingest() network error handling
  - [ ] Test _run_gitingest() repository not found error
  - [ ] Test _run_gitingest() authentication error
  - [ ] Use pytest.tmp_path for isolated filesystem testing
  - [ ] Use unittest.mock.patch for subprocess mocking

## Dev Notes

### Previous Story Insights
Dependencies:
- Story 1.2 (exceptions) - Uses GitIngestError, StorageError
- Story 1.3 (storage) - Uses ensure_data_directory() for path management

### Architecture Overview
The extractor module wraps GitIngest CLI with subprocess calls, handling all aspects of repository extraction including error handling, timeout protection, and file system operations. This story implements the full extraction path for repositories under the 200k token threshold.

[Source: architecture.md#2.4 Extractor Module, prd.md#FR2]

### Module Functions

**extract_full(url: str, repo_name: str) -> str**
```python
def extract_full(url: str, repo_name: str) -> str:
    """
    Extract entire repository.

    Args:
        url: GitHub repository URL
        repo_name: Repository name for storage

    Returns:
        Absolute path to digest.txt file

    Raises:
        GitIngestError: If extraction fails
        StorageError: If directory creation fails
        TimeoutError: If extraction exceeds timeout

    Examples:
        >>> extract_full("https://github.com/octocat/Hello-World", "Hello-World")
        '/path/to/data/Hello-World/digest.txt'
    """
```
[Source: architecture.md#2.4, prd.md#FR2]

**Implementation Pattern:**
```python
def extract_full(url: str, repo_name: str) -> str:
    # Ensure directory exists (uses storage module)
    try:
        data_dir = ensure_data_directory(repo_name)
    except Exception as e:
        raise StorageError(f"Failed to create directory: {e}")

    output_file = data_dir / "digest.txt"

    # Build GitIngest command
    args = [url, '-o', str(output_file)]

    # Execute extraction
    _run_gitingest(args, timeout=300)

    # Return absolute path
    return str(output_file.resolve())
```
[Source: architecture.md#2.4]

**_run_gitingest(args: list[str], timeout: int = 300) -> subprocess.CompletedProcess**
```python
def _run_gitingest(args: list[str], timeout: int = 300) -> subprocess.CompletedProcess:
    """
    Execute gitingest with standard error handling.

    Args:
        args: Command arguments (after 'gitingest')
        timeout: Maximum execution time in seconds (default 300)

    Returns:
        CompletedProcess object

    Raises:
        GitIngestError: If command fails
        TimeoutError: If execution exceeds timeout

    Examples:
        >>> _run_gitingest(['https://github.com/user/repo', '-o', 'output.txt'])
        CompletedProcess(...)
    """
```
[Source: architecture.md#3.1 GitIngest CLI Integration]

**Implementation Pattern:**
```python
def _run_gitingest(args: list[str], timeout: int = 300) -> subprocess.CompletedProcess:
    cmd = ['gitingest'] + args

    try:
        return subprocess.run(
            cmd,
            capture_output=True,
            text=True,
            timeout=timeout,
            check=True
        )
    except subprocess.TimeoutExpired:
        raise TimeoutError(f"GitIngest timed out after {timeout}s")
    except subprocess.CalledProcessError as e:
        # Parse GitIngest error messages for user-friendly output
        stderr = e.stderr.lower()
        if "not found" in stderr:
            raise GitIngestError(f"Repository not found: {args[0]}")
        elif "bad credentials" in stderr or "authentication" in stderr:
            raise GitIngestError("Authentication failed (private repo?)")
        elif "could not resolve host" in stderr:
            raise GitIngestError("Network error: Unable to reach GitHub")
        else:
            raise GitIngestError(f"GitIngest error: {e.stderr}")
```
[Source: architecture.md#3.1]

### Design Decisions

**Why private _run_gitingest() helper:**
- DRY principle: Shared by extract_full(), extract_tree(), extract_specific()
- Centralized error handling and timeout logic
- Consistent subprocess execution pattern
- Easier to test and mock
[Source: architecture.md#3.1, #11.1 Design Principles]

**Why 300-second timeout:**
- Full extraction can take several minutes for large repos
- 5 minutes provides reasonable balance
- User receives timeout error rather than hanging indefinitely
- Longer than token counting (120s) because full extraction is heavier
[Source: architecture.md#2.4, prd.md#TR4]

**Why absolute path return:**
- User confirmation messages display full path
- Clear about where files are saved
- Avoids ambiguity with relative paths
- Consistent with storage module pattern
[Source: architecture.md#2.4, #2.5]

**Why separate directory creation:**
- Storage module handles all path logic (DRY)
- Extraction module focuses on GitIngest wrapping
- Clear separation of concerns
- Storage errors wrapped in StorageError, extraction errors in GitIngestError
[Source: architecture.md#2.4, #2.5]

**Error message parsing strategy:**
```python
# GitIngest stderr examples:
"fatal: repository 'https://github.com/user/notfound' not found"
→ "Repository not found: https://github.com/user/notfound"

"fatal: could not read Username for 'https://github.com': terminal prompts disabled"
→ "Authentication failed (private repo?)"

"fatal: unable to access 'https://github.com/': Could not resolve host: github.com"
→ "Network error: Unable to reach GitHub"
```
[Source: architecture.md#5.2, prd.md#TR4]

### File Location

**Created in this story:**
- `extractor.py` at project root

**Test file:**
- `tests/test_extractor.py`

[Source: architecture.md#TR3 Project Structure]

### Storage Schema

**Output Files Created:**
```
data/
  {repo_name}/
    digest.txt              # Full extraction (this story)
    tree.txt                # Tree structure (Story 1.7)
    docs-content.txt        # Selective: docs (Story 1.7)
    installation-content.txt # Selective: installation (Story 1.7)
    code-content.txt        # Selective: code (Story 1.7)
```
[Source: prd.md#FR7, architecture.md#4.1]

**File Content Format:**
```
# Repository: user/repo
# Branch: main
# Files: 42
# Estimated Tokens: 150,000
# Generated: 2025-09-29T10:30:00

================================================================================
FILE: src/main.py
================================================================================

[File content]

================================================================================
FILE: src/utils.py
================================================================================

[File content]
```
[Source: architecture.md#4.2]

### Security Considerations

**Command Injection Prevention:**
```python
# ✅ Good: Use list arguments (no shell interpretation)
subprocess.run(['gitingest', url, '-o', output_file])

# ❌ Bad: Use shell=True with string (vulnerable)
subprocess.run(f"gitingest {url} -o {output_file}", shell=True)
```
[Source: architecture.md#8.2]

**Path Traversal Prevention:**
```python
# Storage module sanitizes repo_name (Story 1.3)
# Ensures paths stay within data/ directory
output_file = data_dir / "digest.txt"
assert output_file.resolve().is_relative_to(Path.cwd())
```
[Source: architecture.md#8.2, #2.5]

### Performance Considerations

**Full Extraction Time:**
- Depends on repository size
- Network bound (clone time)
- Small repos (< 10 MB): < 30 seconds
- Medium repos (10-50 MB): 30-90 seconds
- Large repos (> 50 MB): 1-5 minutes
[Source: prd.md#6.4 Performance Benchmarks]

**Why no progress indication in Phase 1:**
- GitIngest doesn't provide progress callbacks
- Would require custom implementation (out of scope)
- User sees "Extracting..." message from CLI layer
- Future enhancement: Stream stdout for progress
[Source: architecture.md#7.2 Optimization Opportunities]

## Testing

### Testing Standards

**Test File Location:**
- `tests/test_extractor.py`

**Testing Framework:**
- pytest framework
- unittest.mock.patch for subprocess mocking
- pytest.tmp_path fixture for filesystem isolation

**Test Coverage:**
```python
@patch('extractor._run_gitingest')
@patch('storage.ensure_data_directory')
def test_extract_full_success(mock_ensure_dir, mock_run, tmp_path):
    """Test successful full extraction."""
    mock_ensure_dir.return_value = tmp_path / "data" / "test-repo"
    mock_ensure_dir.return_value.mkdir(parents=True)

    output_path = extract_full("https://github.com/user/repo", "test-repo")

    assert "digest.txt" in output_path
    mock_run.assert_called_once()

@patch('extractor._run_gitingest')
@patch('storage.ensure_data_directory')
def test_extract_full_returns_absolute_path(mock_ensure_dir, mock_run, tmp_path):
    """Test absolute path is returned."""
    mock_ensure_dir.return_value = tmp_path / "data" / "test-repo"
    mock_ensure_dir.return_value.mkdir(parents=True)

    output_path = extract_full("https://github.com/user/repo", "test-repo")

    assert Path(output_path).is_absolute()

@patch('subprocess.run')
def test_run_gitingest_success(mock_run):
    """Test successful GitIngest execution."""
    mock_run.return_value = Mock(returncode=0, stdout="Success")

    result = _run_gitingest(['url', '-o', 'output.txt'])

    assert result.returncode == 0
    mock_run.assert_called_once()

@patch('subprocess.run')
def test_run_gitingest_timeout(mock_run):
    """Test timeout handling."""
    mock_run.side_effect = subprocess.TimeoutExpired(cmd=['gitingest'], timeout=300)

    with pytest.raises(TimeoutError) as exc_info:
        _run_gitingest(['url', '-o', 'output.txt'], timeout=300)

    assert "timed out after 300s" in str(exc_info.value)

@patch('subprocess.run')
def test_run_gitingest_repo_not_found(mock_run):
    """Test repository not found error."""
    mock_run.side_effect = subprocess.CalledProcessError(
        returncode=128,
        cmd=['gitingest'],
        stderr="fatal: repository 'https://github.com/user/notfound' not found"
    )

    with pytest.raises(GitIngestError) as exc_info:
        _run_gitingest(['https://github.com/user/notfound', '-o', 'output.txt'])

    assert "Repository not found" in str(exc_info.value)

@patch('subprocess.run')
def test_run_gitingest_authentication_error(mock_run):
    """Test authentication error for private repos."""
    mock_run.side_effect = subprocess.CalledProcessError(
        returncode=128,
        cmd=['gitingest'],
        stderr="fatal: could not read Username: bad credentials"
    )

    with pytest.raises(GitIngestError) as exc_info:
        _run_gitingest(['url', '-o', 'output.txt'])

    assert "Authentication failed" in str(exc_info.value)

@patch('subprocess.run')
def test_run_gitingest_network_error(mock_run):
    """Test network error handling."""
    mock_run.side_effect = subprocess.CalledProcessError(
        returncode=128,
        cmd=['gitingest'],
        stderr="fatal: unable to access: Could not resolve host: github.com"
    )

    with pytest.raises(GitIngestError) as exc_info:
        _run_gitingest(['url', '-o', 'output.txt'])

    assert "Network error" in str(exc_info.value)

@patch('extractor._run_gitingest')
@patch('storage.ensure_data_directory')
def test_extract_full_storage_error(mock_ensure_dir, mock_run):
    """Test storage error handling."""
    mock_ensure_dir.side_effect = PermissionError("Permission denied")

    with pytest.raises(StorageError) as exc_info:
        extract_full("https://github.com/user/repo", "test-repo")

    assert "Failed to create directory" in str(exc_info.value)
```

**Coverage Target:** 90%+ (critical path for extraction workflow)

### Success Criteria

**Functional Completeness:**
- [ ] extract_full() function implemented
- [ ] _run_gitingest() helper function implemented
- [ ] Directory creation working (uses storage module)
- [ ] Timeout protection working
- [ ] Error handling comprehensive
- [ ] Absolute paths returned
- [ ] All tests pass

**Code Quality:**
- [ ] Clear separation of concerns (extraction vs. storage)
- [ ] Comprehensive error messages
- [ ] Type hints complete
- [ ] Docstrings with examples
- [ ] No shell=True usage (security)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-29 | 1.0 | Initial story creation | Scrum Master (Bob) |

## Dev Agent Record

### Agent Model Used
_Populated by Dev Agent during implementation_

### Debug Log References
_Populated by Dev Agent during implementation_

### Completion Notes
_Populated by Dev Agent during implementation_

### File List
_Populated by Dev Agent during implementation_

## QA Results
_Populated by QA Agent after implementation_