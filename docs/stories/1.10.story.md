# Story 1.10: CLI Extract-Tree & Extract-Specific Commands

## Status
Complete

## Story
**As a** user analyzing a large repository,
**I want** CLI commands for tree extraction and selective content extraction,
**so that** I can view repository structure and extract targeted content to stay within token limits.

## Acceptance Criteria
1. extract_tree subcommand displays repository structure
2. extract_specific subcommand extracts filtered content based on type
3. extract_specific uses --type option with choices (docs, installation, code, auto)
4. Tree structure displayed to user after extraction
5. Output paths confirmed for both commands
6. Token counts displayed after extraction
7. Unit tests verify both commands with various content types

## Tasks / Subtasks

- [x] **Task 1: Implement extract_tree command** (AC: 1, 4, 5, 6)
  - [x] Add @gitingest_agent.command() decorator
  - [x] Add @click.argument('url') for GitHub URL
  - [x] Parse repo_name from URL
  - [x] Display "Extracting tree structure..." message
  - [x] Call extractor.extract_tree(url, repo_name)
  - [x] Display tree content to user
  - [x] Display "✓ Saved to: [path]" confirmation

- [x] **Task 2: Implement extract_specific command** (AC: 2, 3, 5, 6)
  - [x] Add @gitingest_agent.command() decorator
  - [x] Add @click.argument('url') for GitHub URL
  - [x] Add @click.option('--type', required=True, type=click.Choice(['docs', 'installation', 'code', 'auto']))
  - [x] Parse repo_name from URL
  - [x] Display "Extracting {type} content..." message
  - [x] Call extractor.extract_specific(url, repo_name, type)
  - [x] Count tokens in result file
  - [x] Display output path and token count

- [x] **Task 3: Error handling for both commands**
  - [x] Handle GitIngestError
  - [x] Handle StorageError
  - [x] Handle ValidationError
  - [x] Raise click.Abort() on errors

- [x] **Task 4: Write unit tests** (AC: 7)
  - [x] Test extract_tree command success
  - [x] Test extract_tree displays tree content
  - [x] Test extract_specific with --type docs
  - [x] Test extract_specific with --type installation
  - [x] Test extract_specific with --type code
  - [x] Test extract_specific with --type auto
  - [x] Test extract_specific missing --type option
  - [x] Test extract_specific invalid --type value
  - [x] Use CliRunner for testing
  - [x] Mock extractor module functions

## Dev Notes

### Previous Story Insights
Dependencies:
- Story 1.3 (storage) - parse_repo_name()
- Story 1.4 (workflow) - format_token_count()
- Story 1.5 (token_counter) - count_tokens_from_file()
- Story 1.7 (extractor) - extract_tree(), extract_specific()
- Story 1.8 (CLI framework) - gitingest_agent command group

### Architecture Overview
These commands implement the selective extraction workflow for large repositories. extract_tree provides structure overview, and extract_specific applies content filters to reduce token count.

[Source: architecture.md#2.1 CLI Layer, prd.md#US3, #FR3]

### Command Implementations

**extract_tree command:**
```python
@gitingest_agent.command()
@click.argument('url')
def extract_tree(url: str):
    """
    Extract repository tree structure.

    Displays file/directory structure without full content.
    Used for large repositories (>= 200k tokens).

    Args:
        url: GitHub repository URL

    Example:
        gitingest-agent extract-tree https://github.com/fastapi/fastapi
    """
    try:
        repo_name = parse_repo_name(url)

        click.echo("Extracting tree structure...")

        # Extract tree (returns path and content)
        output_path, tree_content = extractor.extract_tree(url, repo_name)

        # Display tree to user
        click.echo("\nRepository structure:")
        click.echo(tree_content)

        click.echo(f"\n✓ Saved to: {output_path}")

    except GitIngestError as e:
        click.echo(f"❌ Extraction failed: {e}", err=True)
        raise click.Abort()
    except StorageError as e:
        click.echo(f"❌ Storage error: {e}", err=True)
        raise click.Abort()
    except ValidationError as e:
        click.echo(f"❌ Invalid URL: {e}", err=True)
        raise click.Abort()
```
[Source: architecture.md#2.1, prd.md#FR3]

**extract_specific command:**
```python
@gitingest_agent.command()
@click.argument('url')
@click.option('--type', 'content_type', required=True,
              type=click.Choice(['docs', 'installation', 'code', 'auto']),
              help='Type of content to extract')
def extract_specific(url: str, content_type: str):
    """
    Extract specific content from repository using filters.

    Uses content type filters to extract targeted sections:
    - docs: Documentation files (*.md, docs/**, README)
    - installation: Installation files (README, setup.py, package.json)
    - code: Source code (src/**/*.py, lib/**/*.py)
    - auto: Automatic (README + docs)

    Args:
        url: GitHub repository URL
        content_type: Type of content to extract

    Example:
        gitingest-agent extract-specific https://github.com/fastapi/fastapi --type docs
    """
    try:
        repo_name = parse_repo_name(url)

        click.echo(f"Extracting {content_type} content...")

        # Extract specific content
        output_path = extractor.extract_specific(url, repo_name, content_type)

        # Count tokens in result
        token_count = count_tokens_from_file(output_path)
        formatted = format_token_count(token_count)

        # Display confirmation
        click.echo(f"✓ Saved to: {output_path}")
        click.echo(f"Token count: {formatted}")

    except GitIngestError as e:
        click.echo(f"❌ Extraction failed: {e}", err=True)
        raise click.Abort()
    except StorageError as e:
        click.echo(f"❌ Storage error: {e}", err=True)
        raise click.Abort()
    except ValidationError as e:
        click.echo(f"❌ Invalid input: {e}", err=True)
        raise click.Abort()
```
[Source: architecture.md#2.1, prd.md#FR3, #FR4]

### Expected Output

**extract_tree:**
```
$ gitingest-agent extract-tree https://github.com/fastapi/fastapi

Extracting tree structure...

Repository structure:
README.md
setup.py
fastapi/
  __init__.py
  applications.py
  routing.py
docs/
  installation.md
  tutorial.md

✓ Saved to: /path/to/data/fastapi/tree.txt
```

**extract_specific:**
```
$ gitingest-agent extract-specific https://github.com/fastapi/fastapi --type docs

Extracting docs content...
✓ Saved to: /path/to/data/fastapi/docs-content.txt
Token count: 89,450 tokens
```
[Source: prd.md#FR3]

### Design Decisions

**Why Click.Choice for --type option:**
- Enforces valid content types
- Auto-generates help text with choices
- User-friendly error for invalid values
[Source: architecture.md#2.1]

**Why extract_tree displays content directly:**
- User needs to see structure immediately to make selection decision
- Tree content is small (no token overflow risk)
- Avoids user needing to open file manually
[Source: prd.md#FR3, architecture.md#2.4]

**Why extract_specific requires --type:**
- Forces explicit user choice
- No ambiguous default behavior
- Click validation ensures type is provided
[Source: prd.md#FR3, architecture.md#2.1]

## Testing

### Testing Standards

**Test Coverage:**
```python
def test_extract_tree_command():
    """Test tree extraction command."""
    runner = CliRunner()
    with patch('storage.parse_repo_name', return_value='test-repo'):
        with patch('extractor.extract_tree', return_value=('/path/tree.txt', 'README.md\nsrc/')):
            result = runner.invoke(extract_tree, ['https://github.com/user/repo'])

            assert result.exit_code == 0
            assert "Extracting tree structure..." in result.output
            assert "Repository structure:" in result.output
            assert "README.md" in result.output
            assert "Saved to:" in result.output

def test_extract_specific_docs():
    """Test selective extraction with docs type."""
    runner = CliRunner()
    with patch('storage.parse_repo_name', return_value='test-repo'):
        with patch('extractor.extract_specific', return_value='/path/docs-content.txt'):
            with patch('token_counter.count_tokens_from_file', return_value=89_450):
                with patch('workflow.format_token_count', return_value='89,450 tokens'):
                    result = runner.invoke(extract_specific,
                        ['https://github.com/user/repo', '--type', 'docs'])

                    assert result.exit_code == 0
                    assert "Extracting docs content..." in result.output
                    assert "89,450 tokens" in result.output

def test_extract_specific_missing_type():
    """Test error when --type option missing."""
    runner = CliRunner()
    result = runner.invoke(extract_specific, ['https://github.com/user/repo'])

    assert result.exit_code != 0
    assert "Missing option" in result.output or "required" in result.output.lower()

def test_extract_specific_invalid_type():
    """Test error with invalid content type."""
    runner = CliRunner()
    result = runner.invoke(extract_specific,
        ['https://github.com/user/repo', '--type', 'invalid'])

    assert result.exit_code != 0
    assert "Invalid value" in result.output or "choice" in result.output.lower()
```

**Coverage Target:** 90%+

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-29 | 1.0 | Initial story creation | Scrum Master (Bob) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References
- Same import pattern as Story 1.9: using `import extractor` to avoid name collisions
- All test mocks updated to `cli.extractor.extract_tree` and `cli.extractor.extract_specific` patterns

### Completion Notes
**Implementation Summary:**
- Added extract_tree command to cli.py (39 lines including docstring)
- Added extract_specific command to cli.py (49 lines including docstring)
- extract_tree displays tree content directly to user and saves to file
- extract_specific uses Click.Choice for --type validation with 4 options (docs, installation, code, auto)
- Both commands integrated with storage, extractor, and token_counter modules
- Comprehensive error handling for ValidationError, StorageError, and GitIngestError
- Created 14 comprehensive tests across both commands

**Test Results:**
- 5 new tests for extract_tree command (100% pass rate)
- 9 new tests for extract_specific command (100% pass rate)
- Combined with existing tests: 34 tests passing total
- cli.py coverage: 94% (87 statements, 5 misses on exception paths and __main__)

**Entry Point Verification:**
```bash
$ uv run gitingest-agent --help
Commands:
  check-size        Check token count and determine extraction strategy.
  extract-full      Extract entire repository to data/ directory.
  extract-specific  Extract specific content from repository using filters.
  extract-tree      Extract repository tree structure.

$ uv run gitingest-agent extract-tree --help
Usage: gitingest-agent extract-tree [OPTIONS] URL
  Extract repository tree structure.

$ uv run gitingest-agent extract-specific --help
Usage: gitingest-agent extract-specific [OPTIONS] URL
  --type [docs|installation|code|auto]  (required)
```

**Key Features Implemented:**

**extract-tree command:**
1. Displays repository structure directly to user
2. Saves tree to file with absolute path confirmation
3. No token counting (tree is always small)
4. Clean formatted output with "Repository structure:" header

**extract-specific command:**
1. --type option with Click.Choice validation (4 types)
2. Required option ensures explicit user choice
3. Dynamic message: "Extracting {type} content..."
4. Token count display after extraction
5. Absolute path confirmation
6. Comprehensive error handling

### File List
**Modified:**
- cli.py: Added extract_tree command (lines 100-138) and extract_specific command (lines 141-187)
- tests/test_cli.py: Added TestExtractTreeCommand class (5 tests) and TestExtractSpecificCommand class (9 tests)

## QA Results
_Populated by QA Agent after implementation_