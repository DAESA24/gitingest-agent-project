# Story 1.1: Automatic Token Size Checking

## Status
Draft

## Story
**As a** developer analyzing a GitHub repository,
**I want** the agent to automatically check token size without manual commands,
**so that** I don't waste time manually counting tokens or guessing repository size.

## Acceptance Criteria
1. Agent executes check-size automatically on GitHub URL detection
2. Token count displayed clearly (formatted with commas)
3. Decision made automatically: "full extraction" or "selective extraction"
4. No user confirmation required for size check

## Tasks / Subtasks

- [ ] **Task 1: Create token_counter.py module** (AC: 1, 2, 3, 4)
  - [ ] Implement `count_tokens(url: str) -> int` function
    - [ ] Use subprocess to call `gitingest <url> -o -` (stdout output)
    - [ ] Set timeout to 120 seconds [Source: architecture.md#2.2 Token Counter Module]
    - [ ] Parse "Estimated tokens: NNNN" pattern from GitIngest output
    - [ ] Implement fallback character estimation (4 chars ≈ 1 token) [Source: architecture.md#2.2]
  - [ ] Implement `should_extract_full(token_count: int, threshold: int = 200_000) -> bool` function
    - [ ] Return True if token_count < threshold
    - [ ] Return False if token_count >= threshold
    - [ ] Make threshold parameter configurable with default 200k [Source: architecture.md#2.2]
  - [ ] Implement error handling for count_tokens
    - [ ] Raise TimeoutError on subprocess timeout (assume very large repo) [Source: architecture.md#2.2]
    - [ ] Raise GitIngestError on network/clone failures with descriptive message [Source: architecture.md#2.2]
    - [ ] Raise ValueError on invalid URL format [Source: architecture.md#2.2]

- [ ] **Task 2: Create workflow.py module** (AC: 2, 3)
  - [ ] Implement `format_token_count(count: int) -> str` function
    - [ ] Format with commas separator (e.g., "145,000 tokens")
    - [ ] Include both full number and k-notation for large counts [Source: architecture.md#2.3]
  - [ ] Implement `validate_github_url(url: str) -> tuple[str, str]` function
    - [ ] Use regex pattern: `r'https?://github\.com/([\w-]+)/([\w-]+)'` [Source: architecture.md#8.1]
    - [ ] Return tuple of (owner, repo_name)
    - [ ] Raise ValidationError if URL doesn't match pattern [Source: architecture.md#8.1]

- [ ] **Task 3: Create CLI check-size command in cli.py** (AC: 1, 2, 3, 4)
  - [ ] Create Click command group `gitingest_agent()` as parent command
  - [ ] Implement `check_size` subcommand with URL argument
  - [ ] Integrate token_counter.count_tokens() function
  - [ ] Display output format:
    ```
    Checking repository size...
    Token count: 145,000
    Route: full extraction
    ```
    [Source: prd.md#FR1 Token Size Checking]
  - [ ] Display error messages with Click.echo for user-friendly output
  - [ ] No confirmation prompts - automatic execution [Source: prd.md#US1 AC4]

- [ ] **Task 4: Create custom exception classes** (AC: All)
  - [ ] Create exceptions.py or add to relevant module
  - [ ] Define `GitIngestAgentError(Exception)` base class [Source: architecture.md#5.1]
  - [ ] Define `GitIngestError(GitIngestAgentError)` for CLI failures [Source: architecture.md#5.1]
  - [ ] Define `ValidationError(GitIngestAgentError)` for input validation [Source: architecture.md#5.1]
  - [ ] Define `TimeoutError` or use built-in [Source: architecture.md#5.1]

- [ ] **Task 5: Create pyproject.toml configuration** (AC: All - Infrastructure)
  - [ ] Set name = "gitingest-agent"
  - [ ] Set version = "0.1.0"
  - [ ] Set requires-python = ">=3.12" [Source: architecture.md#9.2]
  - [ ] Add Click dependency: "click>=8.1.0" [Source: architecture.md#9.2]
  - [ ] Configure entry point: `gitingest-agent = "cli:gitingest_agent"` [Source: architecture.md#9.2]
  - [ ] Set build-system to hatchling [Source: architecture.md#9.2]

- [ ] **Task 6: Write unit tests for token_counter.py**
  - [ ] Test `count_tokens()` with mocked subprocess output (< 200k tokens)
  - [ ] Test `count_tokens()` with mocked subprocess output (>= 200k tokens)
  - [ ] Test parsing of "Estimated tokens: NNNN" pattern
  - [ ] Test character-based fallback calculation
  - [ ] Test timeout error handling
  - [ ] Test network error handling
  - [ ] Test invalid URL error handling
  - [ ] Test `should_extract_full()` with various token counts
  - [ ] Use unittest.mock.patch for subprocess.run mocking [Source: architecture.md#6.2]

- [ ] **Task 7: Write unit tests for workflow.py**
  - [ ] Test `format_token_count()` with various numbers
  - [ ] Test `validate_github_url()` with valid URLs
  - [ ] Test `validate_github_url()` with invalid URLs
  - [ ] Verify ValidationError raised on invalid input

- [ ] **Task 8: Write CLI tests for check-size command**
  - [ ] Use Click's CliRunner for testing [Source: architecture.md#2.1]
  - [ ] Mock token_counter.count_tokens() to return < 200k
  - [ ] Mock token_counter.count_tokens() to return >= 200k
  - [ ] Verify output formatting matches specification
  - [ ] Verify exit code 0 on success
  - [ ] Test error handling scenarios

## Dev Notes

### Previous Story Insights
This is the first story (1.1) in Epic 1, so no previous story context exists.

### Architecture Overview
This story implements the foundational token counting and routing logic that determines all subsequent workflow behavior. The 200,000 token threshold is a critical decision point that routes users to either full extraction or selective extraction workflows.

[Source: architecture.md#1.1 High-Level Architecture]

### Module Structure & Responsibilities

**token_counter.py** - Token counting and workflow routing decisions
- Primary responsibility: Count tokens in repositories using GitIngest CLI
- Secondary responsibility: Determine full vs. selective extraction routing
- Integration: Wraps GitIngest via subprocess, parses output
[Source: architecture.md#2.2 Token Counter Module]

**workflow.py** - Workflow routing logic and utility functions
- Primary responsibility: Utility functions for URL validation and formatting
- Secondary responsibility: Content type filter mapping (used in later stories)
- Integration: Provides validation and display formatting helpers
[Source: architecture.md#2.3 Workflow Module]

**cli.py** - User-facing Click command interface
- Primary responsibility: Command-line interface using Click framework
- Pattern: Command Group with Subcommands
- This story implements the `check-size` subcommand only
[Source: architecture.md#2.1 CLI Layer]

### Technical Implementation Details

**GitIngest Integration Pattern:**
```python
result = subprocess.run(
    ['gitingest', url, '-o', '-'],
    capture_output=True,
    text=True,
    timeout=120
)
```
- Use list arguments (NOT shell=True) for security [Source: architecture.md#8.2]
- Capture stdout for token estimation
- Set 120 second timeout for token counting [Source: architecture.md#2.2]
- GitIngest installed globally via UV tool (not in pyproject.toml) [Source: architecture.md#3.1]

**Token Estimation Strategy:**
1. Primary: Parse "Estimated tokens: NNNN" from GitIngest output
2. Fallback: Character-based estimation (4 chars ≈ 1 token)
3. Tolerance: ±10% accuracy acceptable [Source: prd.md#6.2 Quality Gates]
[Source: architecture.md#2.2]

**Decision Threshold:**
- Threshold: 200,000 tokens (configurable parameter)
- Decision: token_count < 200k → "full extraction"
- Decision: token_count >= 200k → "selective extraction"
[Source: architecture.md#2.2, prd.md#FR1]

**Error Handling Strategy:**

Network Errors:
- Pattern: "could not resolve host" in stderr
- Response: Display user-friendly message, suggest checking internet connection
- Recovery: Offer retry option or raise click.Abort()
[Source: architecture.md#5.2]

Timeout Errors:
- Trigger: subprocess.TimeoutExpired after 120s
- Interpretation: Repository likely very large
- Response: Raise TimeoutError with descriptive message
[Source: architecture.md#2.2]

Invalid URL:
- Validation: Regex pattern `r'https?://github\.com/([\w-]+)/([\w-]+)'`
- Response: Raise ValidationError with expected format
[Source: architecture.md#8.1]

**CLI Output Format:**
```
Checking repository size...
Token count: 145,000
Route: full extraction
```
- No confirmation prompts (AC4)
- Clear progress indication
- Formatted token count with commas
[Source: prd.md#FR1]

### File Locations & Project Structure

**Module Files (created in project root):**
- `cli.py` - Main CLI entry point
- `token_counter.py` - Token counting logic
- `workflow.py` - Utility functions
- `exceptions.py` or inline in modules - Custom exceptions

**Configuration:**
- `pyproject.toml` - Project configuration at root
- Entry point: `gitingest-agent = "cli:gitingest_agent"`

**Test Files:**
- `tests/test_token_counter.py` - Token counter tests
- `tests/test_workflow.py` - Workflow utility tests
- `tests/test_cli.py` - CLI command tests

[Source: architecture.md#TR3 Project Structure]

### Data Models

**URL Validation:**
- Input: GitHub URL string
- Output: Tuple[str, str] = (owner, repo_name)
- Example: "https://github.com/tiangolo/fastapi" → ("tiangolo", "fastapi")
[Source: architecture.md#2.3]

**Token Count Response:**
- Type: int (estimated token count)
- Range: 0 to potentially millions
- Threshold: 200,000 (configurable)
- Display format: Comma-separated string
[Source: architecture.md#2.2]

### External Dependencies

**GitIngest CLI:**
- Installation: Already installed via `uv tool install gitingest`
- Not in pyproject.toml dependencies (external tool)
- Called via subprocess wrapper
- Command pattern: `gitingest <url> -o -` for stdout
[Source: architecture.md#3.1, prd.md#TR1]

**Click Framework:**
- Version: >=8.1.0
- Usage: Command groups, argument parsing, user interaction
- Testing: Use CliRunner for unit tests
[Source: architecture.md#TR1, #2.1]

### Testing

**Unit Test Requirements:**

Test Coverage Target: 80%+ for core logic (token_counter, workflow modules)
[Source: prd.md#TR5]

**Test Repositories (for future integration tests):**
- Small: https://github.com/octocat/Hello-World (< 10k tokens)
- Large: https://github.com/fastapi/fastapi (> 400k tokens)
[Source: prd.md#TR5]

**Testing Tools:**
- unittest.mock.patch for subprocess mocking
- Click's CliRunner for CLI testing
- Standard pytest/unittest framework
[Source: architecture.md#2.1, #6.2]

**Test Structure:**
```
tests/
├── test_token_counter.py  # Token counting logic tests
├── test_workflow.py       # URL validation and formatting tests
└── test_cli.py            # Check-size command tests
```
[Source: architecture.md#6.1]

**Test Scenarios to Cover:**

token_counter.py:
- Token count under limit (< 200k) → should_extract_full = True
- Token count over limit (>= 200k) → should_extract_full = False
- GitIngest output parsing (pattern match success)
- Fallback character estimation (pattern match failure)
- Timeout error handling (subprocess.TimeoutExpired)
- Network error handling (subprocess.CalledProcessError)
- Invalid URL error handling

workflow.py:
- format_token_count() with various numbers (100, 1000, 10000, 100000, 1000000)
- validate_github_url() with valid GitHub URLs
- validate_github_url() with invalid URLs (wrong domain, missing parts)
- ValidationError raised on invalid input

cli.py:
- check_size command with mocked count < 200k
- check_size command with mocked count >= 200k
- Output formatting verification
- Exit code verification (0 on success)
- Error message display on exceptions

[Source: architecture.md#6.2]

### Performance Benchmarks

**Token Counting Target Times:**
- Small repos (< 50k): < 15 seconds
- Medium repos (50-200k): < 60 seconds
- Large repos (> 200k): < 2 minutes

Note: Performance primarily network-bound (repository cloning time)
[Source: prd.md#6.4 Performance Benchmarks]

### Security Considerations

**Command Injection Prevention:**
- ✅ ALWAYS use list arguments: `['gitingest', url, '-o', '-']`
- ❌ NEVER use shell=True with string commands
[Source: architecture.md#8.2]

**Path Traversal Prevention:**
- Validate URLs with strict regex pattern
- Sanitize repository names from URLs
- No file system operations in this story (handled in later stories)
[Source: architecture.md#8.1]

### Technical Constraints

- Python version: >=3.12 [Source: prd.md#TR1]
- Click version: >=8.1.0 [Source: prd.md#TR1]
- GitIngest: Already installed, external tool dependency
- Timeout: 120s for token counting, 300s for extraction (later stories)
- Threshold: 200,000 tokens (hardcoded for Phase 1, parameterized for testing)

### Success Criteria

**Functional Completeness:**
- [ ] check-size command executes without confirmation prompts
- [ ] Token count displayed with comma formatting
- [ ] Routing decision displayed ("full extraction" or "selective extraction")
- [ ] Error messages are user-friendly and actionable

**Accuracy:**
- [ ] Token counting within ±10% of actual (via character estimation)
- [ ] Workflow routing 100% correct at 200k threshold
- [ ] URL validation catches all invalid formats

**Reliability:**
- [ ] Handles network errors gracefully with retry option
- [ ] Timeout protection prevents infinite hangs
- [ ] No crashes on invalid inputs

[Source: prd.md#6.2 Quality Gates]

## Testing

### Testing Standards

**Test File Location:**
- All test files in `tests/` directory at project root
- Naming convention: `test_{module_name}.py`
[Source: architecture.md#6.1]

**Testing Frameworks:**
- Use Python's standard unittest or pytest framework
- Use unittest.mock for mocking subprocess calls
- Use Click's CliRunner for CLI command testing
[Source: architecture.md#2.1, #6.2]

**Testing Patterns:**

Unit Tests (Isolated):
- Mock external dependencies (subprocess, GitIngest)
- Test individual functions in isolation
- Fast execution, no network calls
[Source: architecture.md#6.2]

Integration Tests (later story):
- Test with real GitIngest CLI
- Use test repositories from fixtures
- May be slow due to network operations

**Specific Testing Requirements for This Story:**

1. **Mock subprocess.run** for all token_counter.py tests
   - Control GitIngest output for predictable testing
   - Test both success and failure scenarios
   - Verify timeout handling

2. **Use CliRunner** for cli.py check-size command tests
   - Mock token_counter functions to isolate CLI logic
   - Verify output formatting matches specification
   - Test error display and exit codes

3. **Coverage Target:** 80%+ for token_counter.py and workflow.py
   [Source: prd.md#TR5]

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-29 | 1.0 | Initial story creation | Scrum Master (Bob) |

## Dev Agent Record

### Agent Model Used
_Populated by Dev Agent during implementation_

### Debug Log References
_Populated by Dev Agent during implementation_

### Completion Notes
_Populated by Dev Agent during implementation_

### File List
_Populated by Dev Agent during implementation_

## QA Results
_Populated by QA Agent after implementation_