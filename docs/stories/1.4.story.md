# Story 1.4: Workflow Module - Utilities

## Status
Done

## Story
**As a** developer implementing extraction and routing logic,
**I want** workflow utility functions for URL validation, filter mapping, and formatting,
**so that** I can validate inputs, map content types to GitIngest filters, and display user-friendly output.

## Acceptance Criteria
1. workflow.py module created with all required functions
2. validate_github_url() validates URL format and extracts owner/repo
3. format_token_count() formats token counts for user display
4. get_filters_for_type() maps content types to GitIngest filter patterns
5. All functions have comprehensive type hints and docstrings
6. Unit tests cover URL validation edge cases and filter mappings
7. ValidationError raised for invalid GitHub URLs

## Tasks / Subtasks

- [x] **Task 1: Create workflow.py module with imports** (AC: 1)
  - [x] Create workflow.py at project root
  - [x] Import re for URL parsing
  - [x] Import exceptions (ValidationError)
  - [x] Import typing for type hints

- [x] **Task 2: Implement validate_github_url() function** (AC: 2, 7)
  - [x] Define regex pattern for GitHub URLs: `https?://github\.com/([\w-]+)/([\w-]+)`
  - [x] Match URL against pattern
  - [x] Extract owner and repo name from match groups
  - [x] Raise ValidationError if URL doesn't match pattern
  - [x] Handle URLs with/without trailing slashes
  - [x] Handle URLs with/without .git suffix
  - [x] Return tuple[str, str] (owner, repo)

- [x] **Task 3: Implement format_token_count() function** (AC: 3)
  - [x] Accept token count as integer
  - [x] Format with thousand separators (e.g., "145,000")
  - [x] Add "tokens" suffix
  - [x] Return formatted string

- [x] **Task 4: Implement get_filters_for_type() function** (AC: 4)
  - [x] Define FILTER_PATTERNS dictionary constant
  - [x] Map 'docs' type to docs patterns (include: docs/**, *.md, README*, *.rst)
  - [x] Map 'installation' type to installation patterns (include: README*, INSTALL*, setup.py, pyproject.toml, etc.)
  - [x] Map 'code' type to code patterns (include: src/**/*.py, lib/**/*.py)
  - [x] Map 'auto' type to auto patterns (include: README*, docs/**/*.md)
  - [x] Accept content_type parameter
  - [x] Return dict[str, list[str]] with 'include' and 'exclude' keys
  - [x] Raise ValidationError if content_type not in FILTER_PATTERNS

- [x] **Task 5: Write unit tests for workflow.py** (AC: 6)
  - [x] Test validate_github_url() with valid URLs
  - [x] Test validate_github_url() with invalid URLs (raises ValidationError)
  - [x] Test validate_github_url() with trailing slashes
  - [x] Test validate_github_url() with .git suffix
  - [x] Test format_token_count() formatting
  - [x] Test get_filters_for_type() for all content types
  - [x] Test get_filters_for_type() with invalid type (raises ValidationError)

## Dev Notes

### Previous Story Insights
Dependencies: Story 1.2 (exceptions) - Uses ValidationError

### Architecture Overview
The workflow module provides utility functions for URL validation, content type filtering, and user-friendly formatting. These utilities are used across multiple modules (CLI, extractor, token_counter) to maintain consistent validation and display logic.

[Source: architecture.md#2.3 Workflow Module]

### Module Functions

**validate_github_url(url: str) -> tuple[str, str]**
```python
def validate_github_url(url: str) -> tuple[str, str]:
    """
    Validate GitHub URL and extract owner/repo.

    Args:
        url: GitHub repository URL

    Returns:
        Tuple of (owner, repo_name)

    Raises:
        ValidationError: If URL format is invalid

    Examples:
        >>> validate_github_url("https://github.com/tiangolo/fastapi")
        ('tiangolo', 'fastapi')
        >>> validate_github_url("https://github.com/tiangolo/fastapi.git")
        ('tiangolo', 'fastapi')
        >>> validate_github_url("https://github.com/tiangolo/fastapi/")
        ('tiangolo', 'fastapi')
    """
```
[Source: architecture.md#2.3]

**Implementation Strategy:**
```python
pattern = r'https?://github\.com/([\w-]+)/([\w-]+)'

# Remove trailing slashes and .git suffix
clean_url = url.rstrip('/').removesuffix('.git')

match = re.match(pattern, clean_url)
if not match:
    raise ValidationError(f"Invalid GitHub URL: {url}")

owner, repo = match.group(1), match.group(2)
return owner, repo
```

**format_token_count(count: int) -> str**
```python
def format_token_count(count: int) -> str:
    """
    Format token count for user display.

    Args:
        count: Token count

    Returns:
        Formatted string (e.g., "145,000 tokens")

    Examples:
        >>> format_token_count(145000)
        '145,000 tokens'
        >>> format_token_count(1234567)
        '1,234,567 tokens'
    """
```
[Source: architecture.md#2.3]

**Implementation Strategy:**
```python
return f"{count:,} tokens"
```

**get_filters_for_type(content_type: str) -> dict[str, list[str]]**
```python
def get_filters_for_type(content_type: str) -> dict[str, list[str]]:
    """
    Map content type to GitIngest filter patterns.

    Args:
        content_type: Type of content to extract
                     (docs, installation, code, auto)

    Returns:
        Dict with 'include' and 'exclude' pattern lists

    Raises:
        ValidationError: If content_type is invalid

    Examples:
        >>> get_filters_for_type('docs')
        {'include': ['docs/**/*', '*.md', 'README*', '*.rst'],
         'exclude': ['docs/examples/*', 'docs/archive/*']}
    """
```
[Source: architecture.md#2.3, prd.md#FR4]

**Filter Patterns Definition:**
```python
FILTER_PATTERNS = {
    'docs': {
        'include': ['docs/**/*', '*.md', 'README*', '*.rst'],
        'exclude': ['docs/examples/*', 'docs/archive/*']
    },
    'installation': {
        'include': [
            'README*', 'INSTALL*', 'setup.py', 'pyproject.toml',
            'package.json', 'docs/installation*', 'docs/getting-started*'
        ],
        'exclude': []
    },
    'code': {
        'include': ['src/**/*.py', 'lib/**/*.py'],
        'exclude': ['tests/*', '*_test.py', 'test_*.py', 'examples/*']
    },
    'auto': {
        'include': ['README*', 'docs/**/*.md'],
        'exclude': ['docs/examples/*', 'docs/archive/*']
    }
}
```
[Source: architecture.md#2.3, prd.md#FR4]

**Implementation Strategy:**
```python
if content_type not in FILTER_PATTERNS:
    raise ValidationError(f"Invalid content type: {content_type}")
return FILTER_PATTERNS[content_type]
```

### Design Decisions

**Why validate_github_url() returns tuple:**
- Owner and repo name needed separately for API calls and logging
- Tuple unpacking makes usage ergonomic: `owner, repo = validate_github_url(url)`
- Type hints make return structure explicit
[Source: architecture.md#2.3]

**Why FILTER_PATTERNS is a module constant:**
- Single source of truth for all filter definitions
- Easy to extend with new content types
- Testable independently
- Can be referenced from multiple functions
[Source: architecture.md#2.3, #11.1 Design Principles]

**Why include/exclude structure:**
- Matches GitIngest CLI filtering syntax
- Allows both positive (include) and negative (exclude) filtering
- Flexible for complex filter combinations
[Source: prd.md#FR4, architecture.md#2.3]

**Why 'auto' fallback type:**
- Provides sensible default when user unsure
- Focuses on documentation (most universally useful)
- Avoids overwhelming user with too many choices
[Source: prd.md#FR4]

**Language-specific filter patterns:**
Phase 1 uses Python-focused patterns (src/**/*.py). Future enhancement could detect language from repository and adjust patterns accordingly.
[Source: architecture.md#2.3, prd.md#FR4]

### File Location

**Created in this story:**
- `workflow.py` at project root

**Test file:**
- `tests/test_workflow.py`

[Source: architecture.md#TR3 Project Structure]

### Security Considerations

**URL Validation:**
```python
# Strict regex pattern prevents:
# - Path traversal attempts
# - Special characters in URLs
# - Non-GitHub domains
pattern = r'https?://github\.com/([\w-]+)/([\w-]+)'
```
[Source: architecture.md#8.1]

**Input Sanitization:**
- Only alphanumeric, hyphens, underscores allowed in owner/repo names
- Regex match ensures no shell injection via URL
- ValidationError prevents invalid input from propagating
[Source: architecture.md#8.1, #8.2]

## Testing

### Testing Standards

**Test File Location:**
- `tests/test_workflow.py`

**Testing Framework:**
- pytest framework
- No mocking required (pure Python functions)

**Test Coverage:**
```python
def test_validate_github_url_valid():
    """Test URL validation with standard GitHub URL."""

def test_validate_github_url_with_trailing_slash():
    """Test handling of trailing slash."""

def test_validate_github_url_with_git_suffix():
    """Test handling of .git suffix."""

def test_validate_github_url_invalid_format():
    """Test ValidationError raised for invalid URLs."""

def test_validate_github_url_non_github_domain():
    """Test ValidationError for non-GitHub URLs."""

def test_format_token_count():
    """Test token count formatting with thousand separators."""

def test_format_token_count_large_numbers():
    """Test formatting of very large token counts."""

def test_get_filters_for_type_docs():
    """Test filter patterns for docs type."""

def test_get_filters_for_type_installation():
    """Test filter patterns for installation type."""

def test_get_filters_for_type_code():
    """Test filter patterns for code type."""

def test_get_filters_for_type_auto():
    """Test filter patterns for auto type."""

def test_get_filters_for_type_invalid():
    """Test ValidationError for invalid content type."""

def test_filter_patterns_structure():
    """Test all filter patterns have include/exclude keys."""
```

**Coverage Target:** 100% (utility functions with no external dependencies)

### Success Criteria

**Functional Completeness:**
- [x] All 3 utility functions implemented
- [x] URL validation handles all edge cases
- [x] Token count formatting uses thousand separators
- [x] All 4 content types have filter patterns
- [x] Proper error handling for invalid inputs
- [x] All tests pass

**Code Quality:**
- [x] Comprehensive type hints (mypy clean)
- [x] Clear docstrings with examples
- [x] Regex patterns well-documented
- [x] Filter patterns follow GitIngest syntax

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-29 | 1.0 | Initial story creation | Scrum Master (Bob) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References
- Token usage: ~65k / 200k tokens
- Minor fix: Added $ anchor to regex pattern to reject URLs with extra path components

### Completion Notes
Successfully implemented workflow module with 3 utility functions:
- validate_github_url(): Validates GitHub URLs and extracts owner/repo tuple
  - Handles trailing slashes, .git suffix
  - Strict regex with $ anchor prevents extra path components
  - Only allows alphanumeric, hyphens, underscores in names
- format_token_count(): Formats numbers with thousand separators + " tokens"
- get_filters_for_type(): Maps content types to GitIngest filter patterns
  - FILTER_PATTERNS constant defines 4 types: docs, installation, code, auto
  - Returns dict with 'include' and 'exclude' keys

Created comprehensive test suite with 34 tests organized into 5 test classes:
- TestValidateGithubUrl: 16 tests covering valid/invalid URLs, edge cases
- TestFormatTokenCount: 5 tests for number formatting
- TestGetFiltersForType: 7 tests for filter mapping and validation
- TestFilterPatternsStructure: 4 tests verifying constant structure
- TestIntegration: 2 tests for combined workflows

All functions have comprehensive docstrings with examples and type hints.

### File List
**Modified:**
- workflow.py (23 statements, 100% coverage)

**Created:**
- tests/test_workflow.py (179 statements, 100% coverage, 34 tests)

**Test Results:**
- 34 tests passed
- 0 tests failed
- Test execution time: 0.14s
- Coverage: 100% on workflow.py

## QA Results
_Populated by QA Agent after implementation_