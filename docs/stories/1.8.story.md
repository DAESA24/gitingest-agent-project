# Story 1.8: CLI Framework & Check-Size Command

## Status
Complete

## Story
**As a** user of the GitIngest Agent CLI,
**I want** a Click-based command-line interface with a check-size command,
**so that** I can check repository token counts from the terminal and see routing decisions.

## Acceptance Criteria
1. cli.py module created with Click framework setup
2. gitingest_agent parent command group configured
3. check_size subcommand implemented with URL argument
4. Token count formatted and displayed to user (formatted with commas)
5. Routing decision displayed ("full extraction" or "selective extraction")
6. Entry point configured in pyproject.toml: gitingest-agent = "cli:gitingest_agent"
7. Unit tests verify CLI output and argument parsing using CliRunner

## Tasks / Subtasks

- [x] **Task 1: Create cli.py module with Click setup** (AC: 1, 2)
  - [x] Create cli.py at project root
  - [x] Import click framework
  - [x] Import core modules (token_counter, workflow, storage)
  - [x] Define gitingest_agent() parent command group with @click.group()
  - [x] Add docstring: "GitIngest Agent - Automated GitHub repository analysis"
  - [x] Add if __name__ == "__main__": gitingest_agent() block for testing

- [x] **Task 2: Implement check_size command** (AC: 3, 4, 5)
  - [x] Define check_size() function with @gitingest_agent.command()
  - [x] Add @click.argument('url') for GitHub URL
  - [x] Call token_counter.count_tokens(url)
  - [x] Format token count using workflow.format_token_count()
  - [x] Determine routing using token_counter.should_extract_full()
  - [x] Display "Checking repository size..." before execution
  - [x] Display "Token count: [formatted_count]"
  - [x] Display "Route: full extraction" or "Route: selective extraction"
  - [x] Handle GitIngestError and display user-friendly error

- [x] **Task 3: Verify entry point configuration** (AC: 6)
  - [x] Confirm pyproject.toml has [project.scripts] section
  - [x] Confirm entry point: gitingest-agent = "cli:gitingest_agent"
  - [x] Test entry point: `uv run gitingest-agent --help`

- [x] **Task 4: Write unit tests for CLI** (AC: 7)
  - [x] Test check_size command with URL argument
  - [x] Test check_size displays token count
  - [x] Test check_size displays routing decision (< 200k)
  - [x] Test check_size displays routing decision (>= 200k)
  - [x] Test check_size handles invalid URL
  - [x] Test check_size handles network errors
  - [x] Use Click's CliRunner for testing
  - [x] Mock token_counter functions to avoid real GitIngest calls

## Dev Notes

### Previous Story Insights
Dependencies:
- Story 1.1 (project setup) - pyproject.toml entry point
- Story 1.2 (exceptions) - Error handling
- Story 1.4 (workflow) - format_token_count()
- Story 1.5 (token_counter) - count_tokens(), should_extract_full()

### Architecture Overview
The CLI layer is the user-facing interface built on Click framework. This story establishes the command structure and implements the first command (check-size), which is the workflow entry point for token size checking.

[Source: architecture.md#2.1 CLI Layer, prd.md#US1]

### CLI Structure

**Parent Command Group:**
```python
@click.group()
def gitingest_agent():
    """
    GitIngest Agent - Automated GitHub repository analysis.

    Analyzes GitHub repositories using GitIngest with intelligent
    token-aware routing for Claude Code workflows.
    """
    pass
```
[Source: architecture.md#2.1, prd.md#TR2]

**check_size Subcommand:**
```python
@gitingest_agent.command()
@click.argument('url')
def check_size(url: str):
    """
    Check token count and determine extraction strategy.

    Args:
        url: GitHub repository URL

    Example:
        gitingest-agent check-size https://github.com/user/repo
    """
    try:
        click.echo("Checking repository size...")

        # Count tokens
        token_count = count_tokens(url)

        # Format and display
        formatted = format_token_count(token_count)
        click.echo(f"Token count: {formatted}")

        # Determine route
        route = "full extraction" if should_extract_full(token_count) else "selective extraction"
        click.echo(f"Route: {route}")

    except GitIngestError as e:
        click.echo(f"❌ Error: {e}", err=True)
        raise click.Abort()
    except ValidationError as e:
        click.echo(f"❌ Invalid URL: {e}", err=True)
        raise click.Abort()
```
[Source: architecture.md#2.1, prd.md#FR1]

### Design Decisions

**Why Click framework:**
- Command grouping (parent with subcommands)
- Automatic --help generation
- Argument and option parsing with validation
- Built-in error handling
- Testing support via CliRunner
- Consistent with PRD technology choices
[Source: prd.md#TR1, architecture.md#2.1]

**Why parent command group pattern:**
- Organizes subcommands under single entry point
- Enables future global options (--verbose, --quiet)
- Clean command structure: `gitingest-agent <subcommand> <args>`
- Standard CLI pattern for multi-command tools
[Source: architecture.md#2.1, prd.md#TR2]

**Output format for check_size:**
```
$ gitingest-agent check-size https://github.com/octocat/Hello-World

Checking repository size...
Token count: 8,500 tokens
Route: full extraction
```

```
$ gitingest-agent check-size https://github.com/fastapi/fastapi

Checking repository size...
Token count: 487,523 tokens
Route: selective extraction
```
[Source: prd.md#FR1]

**Why "Route" instead of "Recommendation":**
- Clearer terminology for automation (not a suggestion)
- Matches architecture workflow routing concept
- Concise output
[Source: architecture.md#1.2, prd.md#FR1]

**Error handling pattern:**
```python
try:
    # Command logic
except GitIngestError as e:
    click.echo(f"❌ Error: {e}", err=True)
    raise click.Abort()  # Exit with code 1
except ValidationError as e:
    click.echo(f"❌ Invalid URL: {e}", err=True)
    raise click.Abort()
```
[Source: architecture.md#5.2, prd.md#TR4]

### Entry Point Configuration

**pyproject.toml (from Story 1.1):**
```toml
[project.scripts]
gitingest-agent = "cli:gitingest_agent"
```

**Testing Entry Point:**
```bash
# After uv sync
uv run gitingest-agent --help

# Should output:
# Usage: gitingest-agent [OPTIONS] COMMAND [ARGS]...
#
# GitIngest Agent - Automated GitHub repository analysis.
#
# Commands:
#   check-size  Check token count and determine extraction strategy.
```
[Source: architecture.md#9.1 Installation, prd.md#TR2]

### File Location

**Created in this story:**
- `cli.py` at project root

**Test file:**
- `tests/test_cli.py`

[Source: architecture.md#TR3 Project Structure]

### Click Framework Patterns

**Command Naming:**
- Python function: `check_size` (snake_case)
- CLI command: `check-size` (kebab-case, Click automatic conversion)
[Source: architecture.md#2.1]

**Argument vs. Option:**
- URL is positional argument (@click.argument) - required
- Future flags would be options (@click.option) - optional
[Source: prd.md#TR2]

**Testing with CliRunner:**
```python
from click.testing import CliRunner

def test_check_size_command():
    runner = CliRunner()
    with patch('token_counter.count_tokens', return_value=150_000):
        result = runner.invoke(check_size, ['https://github.com/user/repo'])
        assert result.exit_code == 0
        assert "150,000 tokens" in result.output
        assert "full extraction" in result.output
```
[Source: architecture.md#6.2 Testing Strategy]

## Testing

### Testing Standards

**Test File Location:**
- `tests/test_cli.py`

**Testing Framework:**
- pytest framework
- Click's CliRunner for CLI testing
- unittest.mock.patch for module mocking

**Test Coverage:**
```python
from click.testing import CliRunner
from cli import gitingest_agent, check_size

def test_check_size_command_under_threshold():
    """Test check-size with repository under 200k tokens."""
    runner = CliRunner()
    with patch('token_counter.count_tokens', return_value=145_000):
        with patch('workflow.format_token_count', return_value='145,000 tokens'):
            result = runner.invoke(check_size, ['https://github.com/user/repo'])

            assert result.exit_code == 0
            assert "Checking repository size..." in result.output
            assert "145,000 tokens" in result.output
            assert "full extraction" in result.output

def test_check_size_command_over_threshold():
    """Test check-size with repository over 200k tokens."""
    runner = CliRunner()
    with patch('token_counter.count_tokens', return_value=487_523):
        with patch('workflow.format_token_count', return_value='487,523 tokens'):
            result = runner.invoke(check_size, ['https://github.com/fastapi/fastapi'])

            assert result.exit_code == 0
            assert "487,523 tokens" in result.output
            assert "selective extraction" in result.output

def test_check_size_invalid_url():
    """Test check-size with invalid GitHub URL."""
    runner = CliRunner()
    with patch('token_counter.count_tokens', side_effect=ValidationError("Invalid URL")):
        result = runner.invoke(check_size, ['https://invalid-url'])

        assert result.exit_code == 1
        assert "Invalid URL" in result.output

def test_check_size_network_error():
    """Test check-size with network error."""
    runner = CliRunner()
    with patch('token_counter.count_tokens', side_effect=GitIngestError("Network error")):
        result = runner.invoke(check_size, ['https://github.com/user/repo'])

        assert result.exit_code == 1
        assert "Error:" in result.output
        assert "Network error" in result.output

def test_check_size_timeout():
    """Test check-size with timeout error."""
    runner = CliRunner()
    with patch('token_counter.count_tokens', side_effect=TimeoutError("Timed out")):
        result = runner.invoke(check_size, ['https://github.com/huge/repo'])

        assert result.exit_code == 1
        assert "Timed out" in result.output

def test_gitingest_agent_help():
    """Test parent command help output."""
    runner = CliRunner()
    result = runner.invoke(gitingest_agent, ['--help'])

    assert result.exit_code == 0
    assert "GitIngest Agent" in result.output
    assert "check-size" in result.output

def test_check_size_help():
    """Test check-size command help output."""
    runner = CliRunner()
    result = runner.invoke(check_size, ['--help'])

    assert result.exit_code == 0
    assert "Check token count" in result.output
    assert "URL" in result.output
```

**Coverage Target:** 90%+ (critical user interface)

### Success Criteria

**Functional Completeness:**
- [x] CLI framework established with Click
- [x] Parent command group working
- [x] check-size command working
- [x] Token count displayed with formatting
- [x] Routing decision displayed
- [x] Entry point accessible: `gitingest-agent check-size <url>`
- [x] Error handling displays user-friendly messages
- [x] All tests pass

**Code Quality:**
- [x] Clear Click decorators and structure
- [x] Comprehensive error handling
- [x] User-friendly output formatting
- [x] Help text informative

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-29 | 1.0 | Initial story creation | Scrum Master (Bob) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References
- Fixed README.md Unicode encoding issues (invalid UTF-8 bytes)
- Removed TimeoutError from exceptions (not part of exception hierarchy)
- Adjusted test expectations for Click group behavior (exit code 2 for missing command)

### Completion Notes
**Implementation Summary:**
- Created cli.py with Click framework (56 lines)
- Implemented gitingest_agent parent command group
- Implemented check_size subcommand with routing logic
- Created comprehensive test suite with 13 tests
- All tests passing with 96% coverage on cli.py

**Test Results:**
- 13 tests passing (100% pass rate)
- cli.py coverage: 96% (25 statements, 1 miss on __main__ block)
- Test classes: TestCheckSizeCommand (8 tests), TestGitingestAgentGroup (2 tests), TestCLIIntegration (3 tests)

**Entry Point Verification:**
```bash
$ uv run gitingest-agent --help
Usage: gitingest-agent [OPTIONS] COMMAND [ARGS]...
Commands:
  check-size  Check token count and determine extraction strategy.

$ uv run gitingest-agent check-size --help
Usage: gitingest-agent check-size [OPTIONS] URL
```

**Key Features Implemented:**
1. Click command group structure with parent and subcommands
2. check-size command with URL argument
3. Integration with token_counter and workflow modules
4. User-friendly error messages with emoji indicators
5. Proper exception handling (ValidationError, GitIngestError)
6. Comprehensive help text and docstrings

### File List
**Created:**
- cli.py (56 lines) - CLI framework and check-size command
- tests/test_cli.py (161 lines) - Comprehensive CLI test suite

**Modified:**
- README.md - Fixed Unicode encoding issues (3 characters)

## QA Results
_Populated by QA Agent after implementation_