# Story 1.9: CLI Extract-Full Command

## Status
Complete

## Story
**As a** user analyzing a small repository,
**I want** an extract-full CLI command that extracts the entire repository,
**so that** I can quickly extract repositories under 200k tokens without additional prompts.

## Acceptance Criteria
1. extract_full subcommand implemented with URL argument
2. Command extracts repository to data/[repo-name]/digest.txt
3. Repository name automatically parsed from URL
4. Token count displayed after extraction
5. Output path confirmed to user (absolute path)
6. Success message displayed on completion
7. Unit tests verify command output and integration with extractor module

## Tasks / Subtasks

- [x] **Task 1: Implement extract_full command** (AC: 1, 2, 3)
  - [x] Add @gitingest_agent.command() decorator
  - [x] Add @click.argument('url') for GitHub URL
  - [x] Parse repo_name from URL using storage.parse_repo_name()
  - [x] Display "Extracting full repository..." message
  - [x] Call extractor.extract_full(url, repo_name)
  - [x] Capture and return output path

- [x] **Task 2: Display confirmation and metadata** (AC: 4, 5, 6)
  - [x] Call token_counter.count_tokens_from_file() on output file
  - [x] Format token count using workflow.format_token_count()
  - [x] Display "✓ Saved to: [absolute_path]"
  - [x] Display "Token count: [formatted_count]"
  - [x] Display success message

- [x] **Task 3: Error handling** (AC: 7)
  - [x] Handle GitIngestError with user-friendly message
  - [x] Handle StorageError with directory creation instructions
  - [x] Handle ValidationError for invalid URLs
  - [x] Raise click.Abort() on errors

- [x] **Task 4: Write unit tests** (AC: 7)
  - [x] Test extract_full command successful execution
  - [x] Test extract_full displays output path
  - [x] Test extract_full displays token count
  - [x] Test extract_full repo name parsing
  - [x] Test extract_full error handling
  - [x] Use CliRunner for CLI testing
  - [x] Mock extractor and token_counter modules

## Dev Notes

### Previous Story Insights
Dependencies:
- Story 1.3 (storage) - parse_repo_name()
- Story 1.4 (workflow) - format_token_count()
- Story 1.5 (token_counter) - count_tokens_from_file()
- Story 1.6 (extractor) - extract_full()
- Story 1.8 (CLI framework) - gitingest_agent command group

### Architecture Overview
This command implements the full extraction workflow for repositories under 200k tokens. It provides the complete path from URL to saved extraction with user confirmation.

[Source: architecture.md#2.1 CLI Layer, prd.md#US2, #FR2]

### Command Implementation

```python
@gitingest_agent.command()
@click.argument('url')
def extract_full(url: str):
    """
    Extract entire repository to data/ directory.

    Args:
        url: GitHub repository URL

    Example:
        gitingest-agent extract-full https://github.com/octocat/Hello-World
    """
    try:
        # Parse repository name
        repo_name = parse_repo_name(url)

        click.echo("Extracting full repository...")

        # Extract
        output_path = extractor.extract_full(url, repo_name)

        # Count tokens in result
        token_count = count_tokens_from_file(output_path)
        formatted = format_token_count(token_count)

        # Display confirmation
        click.echo(f"✓ Saved to: {output_path}")
        click.echo(f"Token count: {formatted}")

    except GitIngestError as e:
        click.echo(f"❌ Extraction failed: {e}", err=True)
        raise click.Abort()
    except StorageError as e:
        click.echo(f"❌ Storage error: {e}", err=True)
        raise click.Abort()
    except ValidationError as e:
        click.echo(f"❌ Invalid URL: {e}", err=True)
        raise click.Abort()
```
[Source: architecture.md#2.1, prd.md#FR2]

### Expected Output

```
$ gitingest-agent extract-full https://github.com/octocat/Hello-World

Extracting full repository...
✓ Saved to: /path/to/data/Hello-World/digest.txt
Token count: 8,500 tokens
```
[Source: prd.md#FR2]

### Design Decisions

**Why count tokens after extraction:**
- Confirms extraction successful
- Provides final token count to user
- Uses count_tokens_from_file() (faster than re-running GitIngest)
[Source: prd.md#FR2, architecture.md#2.2]

**Why absolute path in confirmation:**
- User knows exactly where file saved
- Can copy path for other tools
- Avoids ambiguity with relative paths
[Source: architecture.md#2.5, prd.md#FR2]

**Why parse_repo_name() at CLI layer:**
- Validates URL early (fail fast)
- Single responsibility: extractor focuses on extraction only
- Repo name needed before calling extractor
[Source: architecture.md#2.1, #2.5]

## Testing

### Testing Standards

**Test Coverage:**
```python
def test_extract_full_command_success():
    """Test successful full extraction."""
    runner = CliRunner()
    with patch('storage.parse_repo_name', return_value='test-repo'):
        with patch('extractor.extract_full', return_value='/path/to/data/test-repo/digest.txt'):
            with patch('token_counter.count_tokens_from_file', return_value=145_000):
                with patch('workflow.format_token_count', return_value='145,000 tokens'):
                    result = runner.invoke(extract_full, ['https://github.com/user/test-repo'])

                    assert result.exit_code == 0
                    assert "Extracting full repository..." in result.output
                    assert "Saved to:" in result.output
                    assert "145,000 tokens" in result.output

def test_extract_full_gitingest_error():
    """Test error handling for GitIngest failure."""
    runner = CliRunner()
    with patch('storage.parse_repo_name', return_value='test-repo'):
        with patch('extractor.extract_full', side_effect=GitIngestError("Repository not found")):
            result = runner.invoke(extract_full, ['https://github.com/user/notfound'])

            assert result.exit_code == 1
            assert "Extraction failed" in result.output
```

**Coverage Target:** 90%+

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-29 | 1.0 | Initial story creation | Scrum Master (Bob) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References
- Fixed import conflicts by using `import extractor` instead of `from extractor import extract_full` to avoid name collision with CLI command function
- Updated all test mocks to use `cli.extractor.extract_full` pattern

### Completion Notes
**Implementation Summary:**
- Added extract_full command to cli.py (28 lines including docstring)
- Integrated with storage.parse_repo_name(), extractor.extract_full(), and token_counter.count_tokens_from_file()
- User-friendly output with absolute path display and token count
- Comprehensive error handling for ValidationError, StorageError, and GitIngestError
- Created 7 comprehensive tests for extract-full command

**Test Results:**
- 7 new tests for extract_full command (100% pass rate)
- Combined with existing tests: 20 tests passing
- cli.py coverage: 94% (87 statements, 5 misses on exception paths and __main__)

**Entry Point Verification:**
```bash
$ uv run gitingest-agent extract-full --help
Usage: gitingest-agent extract-full [OPTIONS] URL

  Extract entire repository to data/ directory.

  Used for repositories under 200k tokens. Extracts complete repository
  content including all files and code.
```

**Key Features Implemented:**
1. extract-full command with URL argument
2. Automatic repository name parsing from URL
3. Integration with full extractor workflow
4. Token count display after extraction
5. Absolute path confirmation to user
6. Comprehensive error handling with user-friendly messages
7. Complete test coverage for all scenarios

### File List
**Modified:**
- cli.py: Added extract_full command function (lines 57-97)
- tests/test_cli.py: Added TestExtractFullCommand class with 7 tests

## QA Results
_Populated by QA Agent after implementation_