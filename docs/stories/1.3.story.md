# Story 1.3: Storage Module - Core Functions

## Status
Done

## Story
**As a** developer implementing extraction and analysis features,
**I want** a storage module that manages file system operations and paths,
**so that** I can reliably save repository extractions and analyses with consistent organization.

## Acceptance Criteria
1. storage.py module created with all required functions
2. parse_repo_name() extracts repository name from GitHub URL
3. ensure_data_directory() creates and returns data/[repo-name]/ path
4. ensure_analyze_directory() creates and returns analyze/[type]/ path
5. All functions use pathlib.Path for cross-platform compatibility
6. Automatic directory creation (mkdir -p behavior)
7. Unit tests cover all functions with various path scenarios

## Tasks / Subtasks

- [x] **Task 1: Create storage.py module with imports** (AC: 1)
  - [x] Create storage.py at project root
  - [x] Import pathlib.Path
  - [x] Import re for URL parsing
  - [x] Import exceptions (StorageError)

- [x] **Task 2: Implement parse_repo_name() function** (AC: 2)
  - [x] Extract repository name from URL (last part after final /)
  - [x] Handle URLs with/without .git suffix
  - [x] Handle URLs with/without trailing slashes
  - [x] Return sanitized repo name (alphanumeric, hyphens, underscores only)
  - [x] Raise ValidationError if URL format invalid

- [x] **Task 3: Implement ensure_data_directory() function** (AC: 3, 6)
  - [x] Accept repo_name parameter
  - [x] Create Path("data") / repo_name
  - [x] Use mkdir(parents=True, exist_ok=True) pattern
  - [x] Return absolute path
  - [x] Raise StorageError on permission errors

- [x] **Task 4: Implement ensure_analyze_directory() function** (AC: 4, 6)
  - [x] Accept analysis_type parameter (installation, workflow, architecture, custom)
  - [x] Create Path("analyze") / analysis_type
  - [x] Use mkdir(parents=True, exist_ok=True) pattern
  - [x] Return absolute path
  - [x] Raise StorageError on permission errors

- [x] **Task 5: Write unit tests for storage.py** (AC: 7)
  - [x] Test parse_repo_name() with various URL formats
  - [x] Test parse_repo_name() with .git suffix
  - [x] Test parse_repo_name() with trailing slashes
  - [x] Test parse_repo_name() sanitization (removes special chars)
  - [x] Test ensure_data_directory() creates directories
  - [x] Test ensure_data_directory() returns absolute path
  - [x] Test ensure_analyze_directory() creates directories
  - [x] Test ensure_analyze_directory() with all analysis types
  - [x] Use pytest tmp_path fixture for isolated file system testing

## Dev Notes

### Previous Story Insights
Dependencies: Story 1.2 (exceptions) - Uses ValidationError and StorageError

### Architecture Overview
The storage module is a standalone utility module with no dependencies on other feature modules. It provides file system abstraction for all extraction and analysis operations.

[Source: architecture.md#2.5 Storage Module]

### Module Functions

**parse_repo_name(url: str) -> str**
```python
def parse_repo_name(url: str) -> str:
    """
    Extract repository name from GitHub URL.

    Args:
        url: GitHub URL (e.g., https://github.com/owner/repo or https://github.com/owner/repo.git)

    Returns:
        Repository name (e.g., "repo" from "https://github.com/owner/repo")

    Raises:
        ValidationError: If URL format is invalid

    Examples:
        >>> parse_repo_name("https://github.com/tiangolo/fastapi")
        'fastapi'
        >>> parse_repo_name("https://github.com/tiangolo/fastapi.git")
        'fastapi'
        >>> parse_repo_name("https://github.com/tiangolo/fastapi/")
        'fastapi'
    """
```
[Source: architecture.md#2.5]

**Implementation Strategy:**
```python
# Extract last path component
parts = url.rstrip('/').split('/')
repo_name = parts[-1]

# Remove .git suffix if present
if repo_name.endswith('.git'):
    repo_name = repo_name[:-4]

# Sanitize: keep only alphanumeric, hyphens, underscores
safe_name = re.sub(r'[^\w-]', '', repo_name)

return safe_name
```

**ensure_data_directory(repo_name: str) -> Path**
```python
def ensure_data_directory(repo_name: str) -> Path:
    """
    Ensure data directory exists for repository.

    Args:
        repo_name: Repository name (sanitized)

    Returns:
        Absolute Path to data/[repo-name]/

    Raises:
        StorageError: If directory creation fails
    """
```
[Source: architecture.md#2.5]

**Implementation Pattern:**
```python
try:
    data_dir = Path("data") / repo_name
    data_dir.mkdir(parents=True, exist_ok=True)
    return data_dir.resolve()  # Return absolute path
except PermissionError as e:
    raise StorageError(f"Permission denied creating directory: {data_dir}")
except OSError as e:
    raise StorageError(f"Failed to create directory: {data_dir}: {e}")
```
[Source: architecture.md#2.5, #5.2]

**ensure_analyze_directory(analysis_type: str) -> Path**
```python
def ensure_analyze_directory(analysis_type: str) -> Path:
    """
    Ensure analyze directory exists for analysis type.

    Args:
        analysis_type: Type of analysis (installation, workflow, architecture, custom)

    Returns:
        Absolute Path to analyze/[type]/

    Raises:
        StorageError: If directory creation fails
    """
```
[Source: architecture.md#2.5]

### File Naming Conventions

**Data Directory Structure:**
```
data/
  {repo_name}/
    digest.txt              # Full extraction (Story 1.6)
    tree.txt                # Tree structure (Story 1.7)
    docs-content.txt        # Selective: docs (Story 1.7)
    installation-content.txt # Selective: installation (Story 1.7)
    code-content.txt        # Selective: code (Story 1.7)
```

**Analysis Directory Structure:**
```
analyze/
  installation/
    {repo_name}.md
  workflow/
    {repo_name}.md
  architecture/
    {repo_name}.md
  custom/
    {repo_name}.md
```
[Source: architecture.md#2.5, prd.md#FR7]

### Design Decisions

**Why pathlib.Path instead of os.path:**
- Modern Python standard (3.4+)
- Cross-platform compatibility
- Object-oriented interface
- Better path manipulation
[Source: architecture.md#11.1 Design Principles]

**Why parents=True, exist_ok=True:**
- Equivalent to `mkdir -p` behavior
- No error if directory already exists
- Creates parent directories automatically
- Simplifies error handling
[Source: architecture.md#2.5]

**Why absolute paths returned:**
- Clear about where files are saved
- Avoids ambiguity with relative paths
- User confirmation displays full path
[Source: architecture.md#2.5]

**Phase 1.5 Note:**
Current implementation uses hardcoded "data/" and "analyze/" paths. Architecture supports future parameterization for multi-location output feature.
[Source: architecture.md#10.1 Phase 1.5 Extensibility]

### File Location

**Created in this story:**
- `storage.py` at project root

**Test file:**
- `tests/test_storage.py`

[Source: architecture.md#TR3 Project Structure]

### Security Considerations

**Path Sanitization:**
```python
# Remove dangerous characters from repo name
safe_repo_name = re.sub(r'[^\w-]', '', repo_name)
```

**Path Traversal Prevention:**
```python
# Ensure paths stay within project directory
output_path = Path("data") / safe_repo_name
assert output_path.resolve().is_relative_to(Path.cwd())
```
[Source: architecture.md#8.1, #8.2]

## Testing

### Testing Standards

**Test File Location:**
- `tests/test_storage.py`

**Testing Framework:**
- pytest with tmp_path fixture for isolated file system testing
- No mocking required (real file system operations in temp directory)

**Test Scenarios:**
```python
def test_parse_repo_name_basic():
    """Test extracting repo name from standard GitHub URL."""

def test_parse_repo_name_with_git_suffix():
    """Test handling .git suffix removal."""

def test_parse_repo_name_with_trailing_slash():
    """Test handling trailing slash."""

def test_parse_repo_name_sanitization():
    """Test removal of special characters."""

def test_ensure_data_directory_creates_path(tmp_path):
    """Test directory creation for data path."""

def test_ensure_data_directory_returns_absolute(tmp_path):
    """Test absolute path is returned."""

def test_ensure_data_directory_idempotent(tmp_path):
    """Test calling twice doesn't error (exist_ok=True)."""

def test_ensure_analyze_directory_all_types(tmp_path):
    """Test creation for all analysis types."""
```

**Coverage Target:** 90%+ (high coverage for utility module)

### Success Criteria

**Functional Completeness:**
- [x] All 3 core functions implemented
- [x] Path operations work cross-platform
- [x] Automatic directory creation works
- [x] Error handling for permission issues
- [x] All tests pass

**Code Quality:**
- [x] Uses pathlib.Path consistently
- [x] Clear function signatures with type hints
- [x] Comprehensive docstrings
- [x] Security: Path sanitization implemented

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-29 | 1.0 | Initial story creation | Scrum Master (Bob) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References
- Token usage: ~52k / 200k tokens
- No issues encountered

### Completion Notes
Successfully implemented storage module with 3 core functions for file system operations:
- parse_repo_name(): Extracts and sanitizes repository name from GitHub URLs (handles .git suffix, trailing slashes, special characters)
- ensure_data_directory(): Creates data/[repo-name]/ with mkdir -p behavior
- ensure_analyze_directory(): Creates analyze/[type]/ with mkdir -p behavior

Created comprehensive test suite with 32 tests organized into 5 test classes:
- TestParseRepoName: 12 tests for URL parsing, edge cases, error handling
- TestEnsureDataDirectory: 6 tests for data directory creation and idempotency
- TestEnsureAnalyzeDirectory: 7 tests for analyze directory creation (all types)
- TestErrorHandling: 4 tests for permission/OS errors (mocked)
- TestIntegration: 3 tests for combined workflow scenarios

All functions use pathlib.Path for cross-platform compatibility, return absolute paths, and have comprehensive error handling with custom exceptions (ValidationError, StorageError).

### File List
**Modified:**
- storage.py (34 statements, 97% coverage - only missing edge case for empty sanitized string)

**Created:**
- tests/test_storage.py (175 statements, 100% coverage, 32 tests)

**Test Results:**
- 32 tests passed
- 0 tests failed
- Test execution time: 0.15s
- Coverage: 97% on storage.py (exceeds 90% target)

## QA Results
_Populated by QA Agent after implementation_